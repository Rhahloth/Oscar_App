<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Record Sale - RO Solutions</title>
    <link rel="stylesheet" href="/static/styles.css" />
    <style>
      .matching-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }
      .matching-pill {
        background-color: #034078;
        color: white;
        padding: 8px 14px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9em;
        border: none;
        white-space: nowrap;
        transition: background-color 0.3s ease;
      }
      .matching-pill:hover {
        background-color: #012c5c;
      }
    </style>
  </head>
  <body>
    <div class="navbar-wrapper">
      <div class="navbar-inner">
        <div class="navbar">
          <div class="navbar-left">
            <img src="/static/logo.png" alt="RO Solutions Logo" class="logo" />
            <div class="company-details-inline">
              <strong>RO Solutions</strong><br />
              <em>Your sales are guaranteed</em><br />
              Tel: +256 778 412 136 <br />
              Email: raysokello@gmail.com
            </div>
          </div>
          <div>
            {% if session.username %}
            <div>BRANCH: {{ session.username }}</div>
            {% endif %}
          </div>
          <div>
            <a href="/dashboard"><button>Back to Main Dashboard</button></a>
          </div>
          <div
            class="navbar-right"
            style="display: flex; align-items: center; gap: 10px"
          >
            {% if session.username %}
            <a href="/logout"
              ><button
                style="
                  background-color: #d9534f;
                  color: white;
                  margin-left: 12px;
                "
              >
                Logout
              </button></a
            >
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <h4>Point of Sales</h4>

      <form
        id="saleForm"
        method="POST"
        action="/submit_sale"
        onsubmit="submitSale(event)"
      >
        <div class="section-box filter-section">
          <label for="productSearch">Search Product</label>
          <input
            id="productSearch"
            placeholder="Type to search..."
            oninput="handleProductInput()"
            autocomplete="off"
          />
          <div
            id="stockStatus"
            style="margin-top: 10px; font-weight: bold"
          ></div>
        </div>

        <div class="form-group">
          <label>Matching Products</label>
          <div id="searchResults" class="matching-container"></div>
        </div>

        <div class="section-box">
          <h5>Sale Items</h5>
          <div
            class="cart-table"
            style="
              max-height: 250px;
              overflow-y: auto;
              background: #f9f9f9;
              padding: 10px;
            "
          >
            <table class="table" id="cartTable">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Qty</th>
                  <th>Price</th>
                  <th>Subtotal</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <h5>Summary</h5>
          <p>Total Quantity: <span id="total_qty">0</span></p>
          <p>Total Amount: UGX <span id="total_amount">0</span></p>
        </div>

        <input type="hidden" name="payment_method" id="payment_method" />
        <input type="hidden" name="cart_data" id="cart_data" />

        <div class="cart-actions" style="text-align: right">
          <button type="button" onclick="finalizeSale('Cash')">Cash</button>
          <button type="button" onclick="finalizeSale('Credit')">Credit</button>
        </div>
      </form>
    </div>

    <script>
      let cart = [];
      const fullProductList = [
        {% for p in products %}
          { name: "{{ p.product_name }}", id: "{{ p.product_id }}", retail: "{{ p.retail_price }}", cost: "{{ p.agent_price }}", quantity: {{ p.quantity }} },
        {% endfor %}
      ];

      function handleProductInput() {
        const input = document.getElementById("productSearch");
        const query = input.value.toLowerCase();
        const status = document.getElementById("stockStatus");
        const resultsDiv = document.getElementById("searchResults");
        resultsDiv.innerHTML = "";
        status.innerHTML = "";

        if (query.length >= 2) {
          const matches = fullProductList.filter(p => p.name.toLowerCase().includes(query));

          matches.forEach(product => {
            const pill = document.createElement("button");
            pill.className = "matching-pill";
            pill.innerText = product.name;
            pill.onclick = () => selectProduct(product);
            resultsDiv.appendChild(pill);
          });

          resultsDiv.style.display = matches.length ? "flex" : "none";
        } else {
          resultsDiv.style.display = "none";
        }
      }

      function selectProduct(product) {
        if (product.quantity === 0) {
          alert("❌ This product is out of stock.");
          return;
        }

        cart.push({
          productId: product.id,
          productName: product.name,
          quantity: 1,
          price: parseFloat(product.retail),
          cost: parseFloat(product.cost),
          subtotal: parseFloat(product.retail)
        });

        renderCart();
        document.getElementById("productSearch").value = "";
        document.getElementById("searchResults").innerHTML = "";
        document.getElementById("searchResults").style.display = "none";

        const status = document.getElementById("stockStatus");
        if (product.quantity < 5) {
          status.innerHTML = `<span style="color: orange;">⚠️ Low Stock (${product.quantity})</span>`;
        } else {
          status.innerHTML = `<span style="color: green;">✅ In Stock (${product.quantity})</span>`;
        }
      }

      function renderCart() {
        const tbody = document.querySelector("#cartTable tbody");
        tbody.innerHTML = "";
        let totalQty = 0;
        let totalAmount = 0;

        cart.forEach((item, i) => {
          totalQty += item.quantity;
          totalAmount += item.subtotal;

          tbody.innerHTML += `
            <tr>
              <td>${item.productName}</td>
              <td><input type="number" min="1" value="${item.quantity}" onchange="updateQty(${i}, this.value)" style="width: 60px;" /></td>
              <td><input type="number" min="0" value="${item.price}" onchange="updatePrice(${i}, this.value)" style="width: 80px;" /></td>
              <td>UGX ${item.subtotal.toLocaleString('en-UG')}</td>
              <td><button type="button" onclick="removeItem(${i})">X</button></td>
            </tr>`;
        });

        document.getElementById("total_qty").innerText = totalQty;
        document.getElementById("total_amount").innerText = totalAmount.toLocaleString('en-UG');
      }

      function updateQty(index, value) {
        cart[index].quantity = parseInt(value) || 1;
        cart[index].subtotal = cart[index].quantity * cart[index].price;
        renderCart();
      }

      function updatePrice(index, value) {
        const newPrice = parseFloat(value) || 0;
        if (newPrice < cart[index].cost) {
          alert("⚠️ Check the price and try again");
          renderCart();
          return;
        }
        cart[index].price = newPrice;
        cart[index].subtotal = cart[index].quantity * cart[index].price;
        renderCart();
      }

      function removeItem(index) {
        cart.splice(index, 1);
        renderCart();
      }

      function submitSale(e) {
        e.preventDefault();
      }

      function finalizeSale(method) {
        if (!cart.length) return alert("Add at least one item.");
        document.getElementById("cart_data").value = JSON.stringify(cart);
        document.getElementById("payment_method").value = method;
        document.getElementById("saleForm").submit();
      }
    </script>
  </body>
</html>
