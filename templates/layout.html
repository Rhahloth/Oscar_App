<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>{% block title %}ROB Solutions{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#034078" />

    <!-- Styles -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles.css') }}"
    />

    <!-- Manifest -->
    <link
      rel="manifest"
      href="{{ url_for('static', filename='manifest.json') }}"
    />

    <!-- Icons -->
    <link
      rel="icon"
      sizes="192x192"
      href="{{ url_for('static', filename='icons/icon-192.png') }}"
    />
    <link
      rel="icon"
      sizes="512x512"
      href="{{ url_for('static', filename='icons/icon-512.png') }}"
    />
  </head>

  <body
    class="{% if request.endpoint in ['login', 'register_owner', 'forgot_password', 'set_business_password', 'set_password_link'] %}login-body{% endif %}"
  >
    {% if request.endpoint not in ['login', 'register_owner'] %}
    <!-- Navbar -->
    <div class="navbar-wrapper">
      <div class="navbar-inner">
        <div class="navbar">
          <div class="navbar-left">
            <img
              src="{{ url_for('static', filename='logo.png') }}"
              alt="ROB Solutions Logo"
              class="logo"
            />
            <strong>ROB Solutions</strong>
          </div>

          <div class="navbar-center">
            {% if session.username %}
            <span>{{ session.username }}</span>
            {% endif %}
          </div>

          <div class="navbar-right">
            {% if session.username and request.endpoint != 'dashboard' %}
            <a href="/dashboard"><button>Back to Dashboard</button></a>
            {% endif %} {% if session.username %}
            <button
              style="background-color: #d9534f; color: white"
              onclick="logoutAndClearCache()"
            >
              Logout
            </button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Main Content -->
    <div
      class="{% if request.endpoint in ['login', 'register_owner', 'forgot_password', 'set_business_password', 'set_password_link'] %}login-wrapper{% else %}container{% endif %}"
      style="margin-top: 120px"
    >
      {% block content %}{% endblock %}
    </div>

    <!-- Service Worker & Offline Preload -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // ✅ Register Service Worker
        if ("serviceWorker" in navigator) {
          navigator.serviceWorker
            .register("/sw.js")
            .then(() => console.log("✅ Service Worker registered"))
            .catch((err) => console.error("❌ Service Worker failed", err));
        }

        // ✅ Preload offline data if salesperson
        {% if session.role == 'salesperson' %}
        fetch("/offline_data")
          .then((res) => res.json())
          .then((data) => {
            localStorage.setItem("products", JSON.stringify(data.products));
            localStorage.setItem("customers", JSON.stringify(data.customers));
            localStorage.setItem("branch_name", data.branch_name);
            console.log("✅ Products, customers, and branch preloaded into localStorage");
          })
          .catch((err) => {
            console.error("❌ Failed to preload data for offline use:", err);
          });
        {% endif %}
      });
    </script>

    <!-- Inactivity Logout Script -->
    <script>
      let inactivityTimeout;
      function logoutUser() {
        alert("⚠️ You’ve been logged out due to inactivity.");
        if (navigator.onLine) {
          logoutAndClearCache();
        } else {
          window.location.href = "/offline_logout";
        }
      }

      function resetInactivityTimer() {
        clearTimeout(inactivityTimeout);
        inactivityTimeout = setTimeout(logoutUser, 3600000); // 1 hour
      }

      ["click", "mousemove", "keydown", "scroll", "touchstart"].forEach(
        (event) => {
          window.addEventListener(event, resetInactivityTimer);
        }
      );

      resetInactivityTimer();
    </script>

    <!-- Enhanced Logout Logic -->
    <script>
      function logoutAndClearCache() {
        fetch("/logout", { credentials: "same-origin" })
          .then(() => {
            if ("serviceWorker" in navigator) {
              navigator.serviceWorker
                .getRegistrations()
                .then((registrations) => {
                  for (let reg of registrations) {
                    reg.unregister();
                  }
                  window.location.href = "/login";
                });
            } else {
              window.location.href = "/login";
            }
          })
          .catch(() => {
            window.location.href = "/login";
          });
      }
    </script>

    <!-- Offline Sync Script -->
    <script src="{{ url_for('static', filename='js/sync.js') }}"></script>

    {% block scripts %}{% endblock %}
  </body>
</html>
