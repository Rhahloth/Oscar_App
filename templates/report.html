{% extends "layout.html" %}
{% block title %}üìà Report Dashboard - ROB Solutions{% endblock %}

{% block content %}
  <h2 style="text-align: center; color: #034078; margin-top: 20px;">üìä Sales Report Dashboard</h2>

  <!-- Quick Access -->
  <div class="form-group action-buttons" style="justify-content: center;">
    <a href="/view_expenses"><button style="background-color: #ff6f61;">üí∞ VIEW EXPENSES</button></a>
  </div>

  <!-- Filters -->
  <form method="POST" class="report-filters">
    <fieldset>
      <legend style="color: #034078; text-align:center; margin-bottom: 20px; font-size:24px">üîç Filter Sales Report</legend>
      <div class="filter-row">

        <div class="filter-item">
          <label>Start Date</label>
          <input type="date" name="start_date" value="{{ request.form.start_date or '' }}">
        </div>
        <div class="filter-item">
          <label>End Date</label>
          <input type="date" name="end_date" value="{{ request.form.end_date or '' }}">
        </div>

        <div class="filter-item">
          <label>Salesperson</label>
          <select name="salesperson">
            <option value="">All</option>
            {% for sp in salespeople %}
            <option value="{{ sp }}" {% if request.form.salesperson == sp %}selected{% endif %}>{{ sp }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="filter-item">
          <label>Payment Type</label>
          <select name="payment_method">
            <option value="">All</option>
            <option value="Cash" {% if request.form.payment_method == 'Cash' %}selected{% endif %}>Cash</option>
            <option value="Credit" {% if request.form.payment_method == 'Credit' %}selected{% endif %}>Credit</option>
          </select>
        </div>
        <div class="filter-item">
          <label>Quick Date</label>
          <select name="quick_range" onchange="this.form.submit()">
            <option value="">-- Select Range --</option>
            <option value="today" {% if quick_range == 'today' %}selected{% endif %}>Today</option>
            <option value="yesterday" {% if quick_range == 'yesterday' %}selected{% endif %}>Yesterday</option>
            <option value="this_week" {% if quick_range == 'this_week' %}selected{% endif %}>This Week</option>
            <option value="last_week" {% if quick_range == 'last_week' %}selected{% endif %}>Last Week</option>
            <option value="this_month" {% if quick_range == 'this_month' %}selected{% endif %}>This Month</option>
            <option value="last_month" {% if quick_range == 'last_month' %}selected{% endif %}>Last Month</option>
          </select>
        </div>
        <div class="filter-item">
          <button type="submit">Apply Filter</button>
        </div>
      </div>
    </fieldset>
  </form>

  {% if request.form.salesperson %}
  <div style="margin: 10px 0; text-align: center; font-size: 22px; font-weight: bold;">
    üìç REPORT FOR <span style="color: #034078;">{{ request.form.salesperson }}</span>
  </div>
  {% endif %}

  <!-- Summary Cards -->
  <div class="summary-container">
    <div class="summary-card" style="border-top: 4px solid #28a745;"><h4>Total Quantity Sold</h4><p>{{ summary.total_quantity or 0 }}</p></div>
    <div class="summary-card" style="border-top: 4px solid #007bff;"><h4>Total Revenue (UGX)</h4><p>UGX {{ "{:,.0f}".format(summary.total_revenue or 0) }}</p></div>
    <div class="summary-card" style="border-top: 4px solid #6f42c1;"><h4>Total Cost Price (UGX)</h4><p>UGX {{ "{:,.0f}".format(summary.total_cost_price or 0) }}</p></div>
    <div class="summary-card" style="border-top: 4px solid #fd7e14;"><h4>Total Expenses (UGX)</h4><p>UGX {{ "{:,.0f}".format(total_expenses or 0) }}</p></div>
    <div class="summary-card" style="border-top: 4px solid #20c997;"><h4>Net Profit (UGX)</h4><p>UGX {{ "{:,.0f}".format(net_balance or 0) }}</p></div>
    <div class="summary-card" style="border-top: 4px solid #17a2b8;"><h4>Top Salesperson</h4><p>{{ top_salesperson.top_salesperson if top_salesperson else 'N/A' }}</p></div>
  </div>

  <!-- Sales Summary Table -->
  <h3 style="color: #034078;">üìã Sales Performance Summary</h3>
  <div class="table-responsive">
    <table class="table">
      <thead>
        <tr style="background-color: #034078; color: white;">
          <th>Salesperson</th>
          <th>Payment Type</th>
          <th>Sales Count</th>
          <th>Total Quantity</th>
          <th>Buying Price (UGX)</th>
          <th>Selling Price (UGX)</th>
          <th>Profit (UGX)</th>
        </tr>
      </thead>
      <tbody>
        {% for row in report %}
        <tr>
          <td>{{ row.salesperson }}</td>
          <td>{{ row.payment_method }}</td>
          <td>{{ row.sales_count }}</td>
          <td>{{ row.total_qty }}</td>
          <td>{{ "{:,.0f}".format(row.total_buying_price or 0) }}</td>
          <td>{{ "{:,.0f}".format(row.total_selling_price or 0) }}</td>
          <td>{{ "{:,.0f}".format(row.profit or 0) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Flex Row: Top Products | Chart | Low Products -->
  <div class="flex-row">
    <div class="flex-left-narrow">
      <h3>üî• Top Selling Products</h3>
      <div class="table-responsive">
        <table class="table">
          <thead><tr><th>Product</th><th>Qty Sold</th></tr></thead>
          <tbody>
            {% for p in top_products %}<tr><td>{{ p.product_name }}</td><td>{{ p.total_qty_sold or 0 }}</td></tr>{% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div class="flex-right-wide">
      <h3 style="text-align: center;">üìä Revenue by Salesperson</h3>
      <canvas id="salesChart" style="width: 100%; height: auto; max-height: 300px;"></canvas>
    </div>
    <div class="flex-left-narrow">
      <h3>üìâ Low Selling Products</h3>
      <div class="table-responsive">
        <table class="table">
          <thead><tr><th>Product</th><th>Qty Sold</th></tr></thead>
          <tbody>
            {% for p in low_products %}<tr><td>{{ p.product_name }}</td><td>{{ p.total_qty_sold or 0 }}</td></tr>{% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Export -->
  <form action="/export_report" method="POST" style="margin-top: 25px; text-align: center;">
    <input type="hidden" name="start_date" value="{{ request.form.start_date }}">
    <input type="hidden" name="end_date" value="{{ request.form.end_date }}">
    <input type="hidden" name="salesperson" value="{{ request.form.salesperson }}">
    <button style="background-color: #0d6efd;">üì• Export to CSV</button>
  </form>

  <!-- Distribution Log -->
  <h3 style="margin-top: 40px; color: #034078;">üöö Stock Distribution Log</h3>
  <div class="table-responsive">
    <table class="table" id="distributionLogTable">
      <thead>
        <tr style="background-color: #6c757d; color: white;">
          <th>Time</th>
          <th>Product</th>
          <th>From (Salesperson)</th>
          <th>To (Salesperson)</th>
          <th>Quantity</th>
          <th>Status</th>
          <th>Total Value (UGX)</th>
        </tr>
      </thead>
      <tbody>
        {% for dist in distribution_log %}
        <tr>
          <td>{{ dist.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
          <td>{{ dist.product_name }}</td>
          <td>{{ dist.from_salesperson }}</td>
          <td>{{ dist.to_salesperson }}</td>
          <td>{{ dist.quantity }}</td>
          <td>{{ dist.status }}</td>
          <td>{{ "{:,.0f}".format(dist.value_ugx or 0) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div id="distribution-pagination-controls" style="display: flex; justify-content: center; margin-top: 20px; gap: 10px;"></div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const rawData = {{ report | tojson }};
  const revenueBySalesperson = {};
  rawData.forEach(row => {
    const sp = row.salesperson;
    const revenue = row.total_selling_price || 0;
    if (!revenueBySalesperson[sp]) revenueBySalesperson[sp] = 0;
    revenueBySalesperson[sp] += revenue;
  });

  const labels = Object.keys(revenueBySalesperson);
  const values = Object.values(revenueBySalesperson);

  new Chart(document.getElementById('salesChart'), {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Total Revenue by Salesperson (UGX)',
        data: values,
        backgroundColor: '#034078'
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true } }
    }
  });
</script>

<script>
  const rowsPerPage = 10;
  let currentPage = 1;

  function paginateDistributionTable() {
    const table = document.getElementById("distributionLogTable");
    const rows = Array.from(table.querySelectorAll("tbody tr"));
    const totalPages = Math.ceil(rows.length / rowsPerPage);

    rows.forEach(row => row.style.display = "none");
    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    rows.slice(start, end).forEach(row => row.style.display = "");

    const controls = document.getElementById("distribution-pagination-controls");
    controls.innerHTML = "";

    const createButton = (text, page, disabled) => {
      const btn = document.createElement("button");
      btn.textContent = text;
      btn.disabled = disabled;
      btn.onclick = () => { currentPage = page; paginateDistributionTable(); };
      controls.appendChild(btn);
    };

    createButton("First", 1, currentPage === 1);
    createButton("¬´ Prev", currentPage - 1, currentPage === 1);
    controls.appendChild(document.createTextNode(` Page ${currentPage} of ${totalPages} `));
    createButton("Next ¬ª", currentPage + 1, currentPage === totalPages);
    createButton("Last", totalPages, currentPage === totalPages);
  }

  window.onload = paginateDistributionTable;
</script>
{% endblock %}