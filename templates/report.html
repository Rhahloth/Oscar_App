{% extends "layout.html" %}
{% block title %}Report Dashboard - RO Solutions{% endblock %}

{% block content %}
<div class="container">
  <h2>üìä Sales Report Dashboard</h2>

  <!-- Quick Access -->
  <div class="form-group action-buttons" style="justify-content: center;">
    <a href="/view_expenses"><button>üí∞ VIEW EXPENSES</button></a>
  </div>

  <!-- Filters -->
  <form method="POST" class="report-filters">
    <fieldset>
      <legend>Filter Sales Report</legend>
      <div class="filter-row">
        <div class="filter-item">
          <label>Start Date</label>
          <input type="date" name="start_date" value="{{ request.form.start_date or '' }}">
        </div>
        <div class="filter-item">
          <label>End Date</label>
          <input type="date" name="end_date" value="{{ request.form.end_date or '' }}">
        </div>
        <div class="filter-item">
          <label>Salesperson</label>
          <select name="salesperson">
            <option value="">All</option>
            {% for sp in salespeople %}
            <option value="{{ sp }}" {% if request.form.salesperson == sp %}selected{% endif %}>{{ sp }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="filter-item">
          <label>Payment Type</label>
          <select name="payment_method">
            <option value="">All</option>
            <option value="Cash" {% if request.form.payment_method == 'Cash' %}selected{% endif %}>Cash</option>
            <option value="Credit" {% if request.form.payment_method == 'Credit' %}selected{% endif %}>Credit</option>
          </select>
        </div>
        <div class="filter-item" style="align-self: flex-end">
          <button type="submit">Apply Filter</button>
        </div>
      </div>
    </fieldset>
  </form>

  <!-- Filter Indicator -->
  {% if request.form.salesperson %}
  <div style="margin: 10px 0; text-align: center; font-size: 22px; font-weight: bold;">
    üìç REPORT FOR <span style="color: #034078;">{{ request.form.salesperson }}</span>
  </div>
  {% endif %}

  <!-- Summary Cards -->
  <div class="summary-container">
    <div class="summary-card"><h4>Total Quantity Sold</h4><p>{{ summary.total_quantity or 0 }}</p></div>
    <div class="summary-card"><h4>Total Revenue (UGX)</h4><p>UGX {{ "{:,.0f}".format(summary.total_revenue or 0) }}</p></div>
    <div class="summary-card"><h4>Total Cost Price (UGX)</h4><p>UGX {{ "{:,.0f}".format(summary.total_cost_price or 0) }}</p></div>
    <div class="summary-card"><h4>Total Expenses (UGX)</h4><p>UGX {{ "{:,.0f}".format(total_expenses or 0) }}</p></div>
    <div class="summary-card"><h4>Net Profit (UGX)</h4><p>UGX {{ "{:,.0f}".format(net_balance or 0) }}</p></div>
    <div class="summary-card"><h4>Top Salesperson</h4><p>{{ top_salesperson.top_salesperson if top_salesperson else 'N/A' }}</p></div>
  </div>

  <!-- Sales Summary Table -->
  <h3>Sales Performance Summary</h3>
  <div class="table-responsive">
    <table class="table">
      <thead>
        <tr>
          <th>Salesperson</th>
          <th>Payment Type</th>
          <th>Sales Count</th>
          <th>Total Quantity</th>
          <th>Buying Price (UGX)</th>
          <th>Selling Price (UGX)</th>
          <th>Profit (UGX)</th>
        </tr>
      </thead>
      <tbody>
        {% for row in report %}
        <tr>
          <td>{{ row.salesperson }}</td>
          <td>{{ row.payment_method }}</td>
          <td>{{ row.sales_count }}</td>
          <td>{{ row.total_qty }}</td>
          <td>{{ "{:,.0f}".format(row.total_buying_price or 0) }}</td>
          <td>{{ "{:,.0f}".format(row.total_selling_price or 0) }}</td>
          <td>{{ "{:,.0f}".format(row.profit or 0) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Chart -->
  <div style="margin: 20px 0;"><canvas id="salesChart" style="max-height: 300px;"></canvas></div>

  <!-- Export to CSV -->
  <form action="/export_report" method="POST" style="margin-top: 15px;">
    <input type="hidden" name="start_date" value="{{ request.form.start_date }}">
    <input type="hidden" name="end_date" value="{{ request.form.end_date }}">
    <input type="hidden" name="salesperson" value="{{ request.form.salesperson }}">
    <button type="submit">Export to CSV</button>
  </form>

  <!-- Distribution Log -->
  <h3 style="margin-top: 40px;">Stock Distribution Log</h3>
  <div class="table-responsive">
    <table class="table">
      <thead>
        <tr>
          <th>Time</th>
          <th>Product</th>
          <th>From (Salesperson)</th>
          <th>To (Salesperson)</th>
          <th>Quantity</th>
          <th>Status</th>
          <th>Total Value (UGX)</th>
        </tr>
      </thead>
      <tbody>
        {% for dist in distribution_log %}
        <tr>
          <td>{{ dist.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
          <td>{{ dist.product_name }}</td>
          <td>{{ dist.from_salesperson }}</td>
          <td>{{ dist.to_salesperson }}</td>
          <td>{{ dist.quantity }}</td>
          <td>{{ dist.status }}</td>
          <td>{{ "{:,.0f}".format(dist.value_ugx or 0) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div style="margin-top: 20px; text-align: center;">
    {% if current_page > 1 %}
      <a href="{{ url_for('report', page=1) }}"><button>First</button></a>
      <a href="{{ url_for('report', page=current_page - 1) }}"><button>&laquo; Prev</button></a>
    {% endif %}
    Page {{ current_page }} of {{ total_pages }}
    {% if current_page < total_pages %}
      <a href="{{ url_for('report', page=current_page + 1) }}"><button>Next &raquo;</button></a>
      <a href="{{ url_for('report', page=total_pages) }}"><button>Last</button></a>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const rawData = {{ report | tojson }};
  const revenueBySalesperson = {};
  rawData.forEach(row => {
    const sp = row.salesperson;
    const revenue = row.total_selling_price || 0;
    if (!revenueBySalesperson[sp]) revenueBySalesperson[sp] = 0;
    revenueBySalesperson[sp] += revenue;
  });

  const labels = Object.keys(revenueBySalesperson);
  const values = Object.values(revenueBySalesperson);

  new Chart(document.getElementById('salesChart'), {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Total Revenue by Salesperson (UGX)',
        data: values,
        backgroundColor: '#034078'
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true } }
    }
  });
</script>
{% endblock %}
