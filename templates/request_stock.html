<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Request Stock - RO Solutions</title>
    <link rel="stylesheet" href="/static/styles.css" />
    <style>
      .cart-table th,
      .cart-table td {
        padding: 8px;
        text-align: center;
      }
      .cart-table {
        margin-top: 20px;
        width: 100%;
        border-collapse: collapse;
      }
      .cart-table th,
      .cart-table td {
        border: 1px solid #ddd;
      }
    </style>
  </head>
  <body>
    <div class="navbar-wrapper">
      <!-- Navbar structure unchanged -->
    </div>

    <div class="container">
      <h4>Request Stock</h4>

      <div class="form-group">
        <label>Search Product</label>
        <input
          type="text"
          id="productSearch"
          onkeyup="filterProducts()"
          placeholder="Type to search products..."
        />
      </div>

      <div class="form-group">
        <label>Product</label>
        <select id="productSelect">
          {% for item in inventory %}
          <option
            value="{{ item.product_id }}"
            data-name="{{ item.product_name }}"
            data-quantity="{{ item.quantity }}"
          >
            {{ item.product_name }}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label>From (Branch)</label>
        <select id="recipientSelect">
          {% for r in recipients %}
          <option value="{{ r.id }}">{{ r.username }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label>Quantity</label>
        <input type="number" id="quantityInput" min="1" />
      </div>

      <button type="button" onclick="addToCart()">âž• Add to Cart</button>

      <form
        method="POST"
        action="/request_stock"
        onsubmit="return prepareSubmission()"
      >
        <input type="hidden" name="request_data" id="requestData" />

        <table class="cart-table" id="cartTable">
          <thead>
            <tr>
              <th>Product</th>
              <th>From Branch</th>
              <th>Quantity</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="form-group">
          <label>Your Full Name</label>
          <input type="text" name="requester_name" required />
        </div>

        <button type="submit">Submit All Requests</button>
      </form>
    </div>

    <script>
      let cart = [];

      function filterProducts() {
        const input = document
          .getElementById("productSearch")
          .value.toLowerCase();
        const options = document.getElementById("productSelect").options;
        for (let i = 0; i < options.length; i++) {
          const text = options[i].text.toLowerCase();
          options[i].style.display = text.includes(input) ? "" : "none";
        }
      }

      function addToCart() {
        const productSelect = document.getElementById("productSelect");
        const recipientSelect = document.getElementById("recipientSelect");
        const quantity = parseInt(
          document.getElementById("quantityInput").value
        );

        if (
          !productSelect.value ||
          !recipientSelect.value ||
          !quantity ||
          quantity < 1
        ) {
          alert("Please complete all fields.");
          return;
        }

        const productName =
          productSelect.options[productSelect.selectedIndex].text;
        const recipientName =
          recipientSelect.options[recipientSelect.selectedIndex].text;

        cart.push({
          product_id: productSelect.value,
          product_name: productName,
          recipient_id: recipientSelect.value,
          recipient_name: recipientName,
          quantity: quantity,
        });

        renderCart();
      }

      function renderCart() {
        const tbody = document.querySelector("#cartTable tbody");
        tbody.innerHTML = "";
        cart.forEach((item, index) => {
          const row = `<tr>
          <td>${item.product_name}</td>
          <td>${item.recipient_name}</td>
          <td>${item.quantity}</td>
          <td><button type="button" onclick="removeFromCart(${index})">Remove</button></td>
        </tr>`;
          tbody.innerHTML += row;
        });
      }

      function removeFromCart(index) {
        cart.splice(index, 1);
        renderCart();
      }

      function prepareSubmission() {
        document.getElementById("requestData").value = JSON.stringify(cart);
        return cart.length > 0;
      }
    </script>
  </body>
</html>
