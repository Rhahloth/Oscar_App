<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Request Stock - RO Solutions</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <div class="navbar-wrapper">
      <div class="navbar-inner">
        <div class="navbar">
          <div class="navbar-left">
            <img src="/static/logo.png" alt="RO Solutions Logo" class="logo" />
            <div class="company-details-inline">
              <strong>RO Solutions</strong><br />
              <em>Your sales are guaranteed</em><br />
              Tel: +256 778 412 136 <br />
              Email: raysokello@gmail.com
            </div>
          </div>
          {% if session.username %}
          <div>BRANCH: {{ session.username }}</div>
          {% endif %}
          <div>
            <a href="/dashboard"><button>Back to Dashboard</button></a>
          </div>
          <div class="navbar-right">
            {% if session.username %}
            <a href="/logout">
              <button style="background-color: #d9534f; color: white">
                Logout
              </button>
            </a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <h3>Request Stock</h3>

      <!-- Search -->
      <label for="productSearch">Search Product:</label>
      <input
        type="text"
        id="productSearch"
        placeholder="Start typing to search..."
        onkeyup="filterProducts()"
        autocomplete="off"
      />

      <!-- Product List -->
      <ul id="productList">
        {% for item in inventory %}
        <li
          data-id="{{ item.product_id }}"
          data-name="{{ item.product_name }}"
          data-quantity="{{ item.quantity }}"
          style="display: none"
          onclick="addToCart('{{ item.product_id }}', '{{ item.product_name }}', {{ item.quantity }})"
        >
          {{ item.product_name }} (Available: {{ item.quantity }})
        </li>
        {% endfor %}
      </ul>

      <h4>Stock Request Cart</h4>
      <form method="POST" action="/request_stock">
        <div class="cart-table" id="cartContainer"></div>

        <div class="form-group">
          <label>FROM (BRANCH)</label>
          <select name="recipient_id" required>
            {% for r in recipients %}
            <option value="{{ r.id }}">{{ r.username }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label>Your Full Name</label>
          <input type="text" name="requester_name" required />
        </div>

        <input type="hidden" name="cart_data" id="cartData" />

        <div class="cart-actions">
          <button type="button" onclick="clearCart()">Clear Cart</button>
          <button type="submit" onclick="prepareSubmission()">
            Submit Request
          </button>
        </div>
      </form>
    </div>

    <script>
      let cart = [];

      function filterProducts() {
        const query = document
          .getElementById("productSearch")
          .value.toLowerCase();
        const items = document.querySelectorAll("#productList li");

        items.forEach((item) => {
          const name = item.getAttribute("data-name").toLowerCase();
          item.style.display =
            query.length >= 2 && name.includes(query) ? "" : "none";
        });
      }

      function addToCart(id, name, available) {
        const existing = cart.find((item) => item.id === id);
        if (existing) {
          existing.quantity += 1;
        } else {
          cart.push({ id, name, quantity: 1, available });
        }

        renderCart();
        clearSearch();
      }

      function renderCart() {
        const container = document.getElementById("cartContainer");
        container.innerHTML = "";

        cart.forEach((item, index) => {
          const div = document.createElement("div");
          div.className = "cart-item";
          div.innerHTML = `
          <span>${item.name}</span>
          <input type="number" min="1" max="${item.available}" value="${item.quantity}" onchange="updateQty(${index}, this.value)">
          <small style="color: grey;">/ ${item.available} max</small>
          <button class="remove-btn" onclick="removeItem(${index})">Remove</button>
        `;
          container.appendChild(div);
        });
      }

      function updateQty(index, newQty) {
        cart[index].quantity = parseInt(newQty);
      }

      function removeItem(index) {
        cart.splice(index, 1);
        renderCart();
      }

      function clearCart() {
        cart = [];
        renderCart();
      }

      function clearSearch() {
        document.getElementById("productSearch").value = "";
        const items = document.querySelectorAll("#productList li");
        items.forEach((item) => (item.style.display = "none"));
      }

      function prepareSubmission() {
        document.getElementById("cartData").value = JSON.stringify(cart);
      }
    </script>
  </body>
</html>
