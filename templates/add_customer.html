{% extends "layout.html" %} {% block title %}Manage Customers & Credit Summary -
RO Solutions{% endblock %} {% block content %}
<h2>ğŸ‘¥ Manage Customers</h2>

{% with messages = get_flashed_messages(with_categories=true) %} {% if messages
%}
<ul>
  {% for category, message in messages %}
  <li style="color: {{ 'green' if category == 'success' else 'red' }}">
    {{ message }}
  </li>
  {% endfor %}
</ul>
{% endif %} {% endwith %}

<div class="flex-container">
  <!-- Left: Add New Customer -->
  <div class="flex-child">
    <h4>â• Add New Customer</h4>
    <form method="POST">
      <input type="hidden" name="action" value="add_customer" />
      <label><strong>Customer Name:</strong></label
      ><br />
      <input type="text" name="name" required style="width: 100%" /><br /><br />

      <label><strong>Phone Number:</strong></label
      ><br />
      <input
        type="text"
        name="phone"
        placeholder="Optional"
        style="width: 100%"
      /><br /><br />

      <button type="submit">â• Add Customer</button>
    </form>
  </div>

  <!-- Right: Active Customers -->
  <div class="flex-child">
    <h4>ğŸ“‹ Active Customers</h4>
    {% if customers %}
    <table class="table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Phone</th>
          <th>Created</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for c in customers %}
        <tr>
          <td>{{ c.name }}</td>
          <td>{{ c.phone or 'â€”' }}</td>
          <td>{{ c.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
          <td>
            <form method="POST" style="display: inline">
              <input type="hidden" name="action" value="toggle_status" />
              <input type="hidden" name="customer_id" value="{{ c.id }}" />
              <button
                type="submit"
                class="{{ 'btn-activate' if not c.is_active else 'btn-deactivate' }}"
              >
                {{ 'Activate' if not c.is_active else 'Deactivate' }}
              </button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>No customers yet.</p>
    {% endif %}
  </div>
</div>

<hr />

<!-- âœ… Credit Summary -->
<h4>ğŸ’³ Credit Summary by Batch</h4>
{% if credit_summary %}
<table class="table">
  <thead>
    <tr>
      <th>Date</th>
      <th>Batch No</th>
      <th>Customer</th>
      <th>Total Credit (UGX)</th>
      <th>Balance (UGX)</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody>
    {% for row in credit_summary %}
    <tr>
      <td>{{ row.date.strftime('%Y-%m-%d') }}</td>
      <td><a href="/batch_sales/{{ row.batch_no }}">{{ row.batch_no }}</a></td>
      <td>{{ row.customer_name }}</td>
      <td>{{ "{:,.0f}".format(row.amount) }}</td>
      <td>{{ "{:,.0f}".format(row.balance or 0) }}</td>
      <td>
        {% if row.balance == 0 %}
        <span class="status paid">âœ… Paid</span>
        {% elif row.balance < row.amount %}
        <span class="status partial">ğŸŸ¡ Partial</span>
        {% else %}
        <span class="status unpaid">âŒ Unpaid</span>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<p>No credit summary available.</p>
{% endif %}

<style>
  .flex-container {
    display: flex;
    gap: 30px;
    flex-wrap: wrap;
    margin-top: 20px;
  }
  .flex-child {
    flex: 1;
    min-width: 300px;
  }
  .status.paid {
    color: green;
    font-weight: bold;
  }
  .status.partial {
    color: orange;
    font-weight: bold;
  }
  .status.unpaid {
    color: red;
    font-weight: bold;
  }
</style>
{% endblock %}
